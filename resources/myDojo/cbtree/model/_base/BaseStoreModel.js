//>>built
define("cbtree/model/_base/BaseStoreModel",["module","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/promise/all","dojo/promise/Promise","dojo/Stateful","dojo/when","./Parents","./Prologue","../../Evented","../../errors/createError!../../errors/CBTErrors.json","../../util/shim/Array"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var _e=_d(_1.id);var _f;function _10(){return true;};var _11=_2([_c,_8],{iconAttr:"",labelAttr:"name",labelType:"text",parentProperty:"parent",query:null,options:null,rootLabel:null,store:null,state:"created",root:null,_forest:false,_loadRequested:false,constructor:function(_12){this._childrenCache={};this._objectCache={};this._obsHandles={};this._methods={};this._eventable=false;this._forest=false;this._loadOptions=null;this._loadRequested=false;this._monitored=false;this._observable=false;this._resetPending=false;this._writeEnabled=true;this._evtHandles={remove:function(){}};this._modelReady=new _5();this._storeReady=new _5();_2.safeMixin(this,_12);var _13=["add","put","get","load","hasChildren","getChildren","getParents","addParent","query","removeParent","queryEngine","notify","emit","dispatchEvent","isItem","ready"];var _14=this.store;if(!_14){throw new _e("ParameterMissing","constructor","Store parameter is required");}if(_14.parentProperty){this.parentProperty=_14.parentProperty;}else{_14.parentProperty=this.parentProperty;}_13.forEach(function(_15){if(typeof _14[_15]=="function"){this._methods[_15]=_14[_15];switch(_15){case "add":if(_14.hierarchical!==true){_4.before(_14,"add",_b);}break;case "dispatchEvent":case "emit":if(_14.eventable===true){this._evtHandles=_14.on("change, delete, new",_3.hitch(this,this._onStoreEvent));this._observable=false;this._eventable=true;}break;case "notify":if(!this._eventable){this._observable=true;}break;case "put":if(_14.hierarchical!==true){_4.before(_14,"put",_b);}break;}}else{switch(_15){case "getChildren":if(typeof _14["query"]=="function"){var _16="return this.query({"+this.parentProperty+": this.getIdentity(object)}, options);";_14.getChildren=new Function(["object","options"],_16);}else{throw new _e("MethodMissing","constructor","store MUST support getChildren()"+" or query() method");}break;case "isItem":_14.isItem=function(_17){if(_17&&typeof _17=="object"){return (_17==this.get(this.getIdentity(_17)));}return false;};break;case "get":throw new _e("MethodMissing","constructor","store MUST support the get() method");case "hasChildren":case "load":case "ready":this._methods[_15]=_10;break;case "put":this._writeEnabled=false;break;}}},this);this._monitored=(this._eventable||this._observable);_4.after(_14,"onClose",_3.hitch(this,"_onStoreClosed"),true);},postscript:function(){this.inherited(arguments);this._loadStore(this._loadOptions);},_parentPropertySetter:function(_18){if(typeof _18=="string"){if(/\./.test(_18)){throw new _e("InvalidType","set","parentProperty can not be a dot separated string");}}else{throw new _e("InvalidType","set","parentProperty value must be a string");}return this.checkedAttr;},destroy:function(){for(var id in this._childrenCache){this._deleteCacheEntry(id);}this._evtHandles.remove();this._childrenCache={};this._objectCache={};this.store=_f;},getChildren:function(_19,_1a,_1b){throw new _e("AbstractOnly","getChildren");},getIcon:function(_1c){if(this.iconAttr){return this._getProp(this.iconAttr,_1c);}},getIdentity:function(_1d){return this.store.getIdentity(_1d);},getLabel:function(_1e){if(_1e===this.root&&this.rootLabel){return this.rootLabel;}return this._getProp(this.labelAttr,_1e);},getParents:function(_1f){var _20=new _5();var _21=[];if(_1f){if(this._methods.getParents){_9(this.store.getParents(_1f),function(_22){_20.resolve(_22||[]);},_20.reject);}else{var _23=new _a(_1f,this.parentProperty);var _24=[];_23.forEach(function(id){var _25=this.store.get(id);if(_25){_9(_25,function(_26){if(_26){_21.push(_26);}});_24.push(_25);}},this);_6(_24).always(function(){_20.resolve(_21);});}}else{_20.resolve(_21);}return _20.promise;},getRoot:function(_27,_28){var _29=this;if(this.root){_9(this._storeReady,function(){_27(_29.root);});}else{if(this._methods.query){_9(this._storeReady,function(){var _2a=_29.store.query(_29.query,_29.options);_9(_2a,function(_2b){if(_2b.length!=1){throw new _e("InvalidResponse","getRoot","Root query returned %{0} items, but must return exactly one",_2b.length);}_29.root=_2b[0];if(_2a.observe){_2a.observe(function(obj,_2c,_2d){if(_2c==_2d){_29._onChange(obj,null);}},true);}_27(_29.root);},_28);},_28);}else{throw new _e("MethodMissing","getRoot","store has no query() method");}}},isItem:function(_2e){return this.store.isItem(_2e);},mayHaveChildren:function(_2f){var _30=this._methods["hasChildren"];var _31=this.getIdentity(_2f);var _32=this._childrenCache[_31];if(_32&&!(_32 instanceof _7)){return !!_32.length;}return _30.call(this.store,_2f);},isChildOf:function(_33,_34){if(_34&&_33){var _35=new _a(_33,this.parentProperty);return _35.contains(this.getIdentity(_34));}return false;},deleteItem:function(_36,_37){var _36=_36 instanceof Array?_36:[_36];var _38=this;function _39(_3a){var _3b=_38.getIdentity(_3a);if(_3b){if(_37){_38.getChildren(_3a,function(_3c){_3c.forEach(_39);});}if(_38._forest&&_3a==_38.root){_38._onDeleteItem(_3a);}else{var _3d=_38.store.remove(_3b);if(!_38._monitored){_9(_3d,function(){_38._onDeleteItem(_3a);});}}if(_3a==_38.root){_38.root=null;}}};_36.forEach(_39);},ready:function(_3e,_3f,_40){if(_3e||_3f){return this._modelReady.then(_3e?_3.hitch((_40||this),_3e):null,_3f?_3.hitch((_40||this),_3f):null);}return this._modelReady.promise;},newItem:function(_41,_42,_43,_44){var _45=_42[this.parentProperty] instanceof Array;var _46=this.getIdentity(_41);var _47=this;var _48;_42=(this._forest&&_42==this.root)?_f:_42;if(_46!=_f){_48=_9(this.store.get(_46),function(_49){if(_49){var _4a=new _a(_49,_47.parentProperty);if(_45){_4a.add(_47.getIdentity(_42),true);_49[_47.parentProperty]=_4a.toValue();_46=_47.store.put(_49);if(!_47._monitored){_9(_46,function(){_47._childrenChanged(_42);});}}else{_47.getParents(_49).then(function(_4b){if(_4b.length){_47.pasteItem(_49,_4b[0],_42,false,_43,_44);}});}return _49;}else{_48=_47.store.put(_41,{parent:_42,before:_44});return _9(_48,function(_4c){return _9(_47.store.get(_4c),function(_4d){if(_4d){if(!_47._monitored){_9(_48,function(){_47._onNewItem(_4d);});}}return _4d;});});}});return _48;}_48=this.store.put(_41,{parent:_42,before:_44});return _9(_48,function(_4e){return _9(_47.store.get(_4e),function(_4f){if(_4f){if(_42==this.root){_47.onRootChange(_4f,"new");}if(!this._monitored){_9(_48,function(){_47._onNewItem(_4f);});}}return _4f;});});},pasteItem:function(_50,_51,_52,_53,_54,_55){var _56=new _a(_50,this.parentProperty);var _57=this.getIdentity(_52);var _58=this.getIdentity(_51);var _59=[_52];var _5a=this;if(_58!=_57){var _5b=(_51==this.root);var _5c=(_52==this.root);if(!_53){_59.push(_51);_56.remove(_58);}if(_5c||_5b){this.onRootChange(_50,(_5c?"attach":"detach"));}if(!this._forest||!_5c){_56.add(_57);}}_50[this.parentProperty]=_56.toValue();var _5d=this.store.put(_50,{before:_55});if(!this._monitored||(this._eventable&&_55)){_9(_5d,function(){_5a._childrenChanged(_59);});}this.onPasteItem(_50,_54,_55);},_onChange:function(_5e,_5f){var _60=this.getIdentity(_5e);_5f=_5f||this._objectCache[_60];if(_5f){var key;for(key in _5f){if(key in _5e){if(_5f[key]!=_5e[key]){this._onSetItem(_5e,key,_5f[key],_5e[key]);}}else{this._onSetItem(_5e,key,_5f[key],_f);}}for(key in _5e){if(!(key in _5f)){this._onSetItem(_5e,key,_f,_5e[key]);}}}this._objectCache[_60]=_3.mixin(null,_5e);},_onChildrenChange:function(_61,_62){this.onChildrenChange(_61,_62);},_onDeleteItem:function(_63){var id=this.getIdentity(_63);var _64=this;_9(this.store.get(id),function(_65){if(!_65){delete _64._objectCache[id];}},function(err){delete _64._objectCache[id];});this._deleteCacheEntry(id);this.onDelete(_63);this.getParents(_63).then(function(_66){if(_64.isChildOf(_63,_64.root)){_64.onRootChange(_63,"delete");}_64._childrenChanged(_66);});},_onNewItem:function(_67){var _68=this;this.getParents(_67).then(function(_69){if(_68.isChildOf(_67,_68.root)){_68.onRootChange(_67,"new");}_68._childrenChanged(_69);});},_onSetItem:function(_6a,_6b,_6c,_6d){var _6e=this.parentProperty;if(_6b===_6e){var np=new _a(_6d,_6e);var op=new _a(_6c,_6e);var _6f=this;var dp=[];np.forEach(function(_70){var a=_6f;var b=op;if(!op.contains(_70)&&_6f._objectCache[_70]){dp.push(_6f._objectCache[_70]);}});op.forEach(function(_71){if(!np.contains(_71)&&_6f._objectCache[_71]){dp.push(_6f._objectCache[_71]);}});if(dp.length){_6f._childrenChanged(dp);this.onChange(_6a,_6b,_6d,_6c);}}else{this.onChange(_6a,_6b,_6d,_6c);}return true;},_onStoreClosed:function(_72,_73){if(!this._resetPending){var _74=!(_73&&_72);if(_74){for(var id in this._childrenCache){this._deleteCacheEntry(id);}this._childrenCache={};this._objectCache={};}if(_72){var _75=this;if(!this._modelReady.isFulfilled()){this._modelReady.cancel(new _e("RequestCancel","_onStoreClosed"));}this._modelReady=new _5();this._storeReady=new _5();this._loadRequested=false;this._resetPending=true;this.state="reset";this.onReset();if(!this._forest){this.root=null;}this._loadStore().then(function(){_75._resetPending=false;});}}},_onStoreEvent:function(_76){var _77=_76;if(_76.detail){_77=_76.detail;}switch(_76.type){case "change":this._onChange(_77.item,null);if(_77.from&&_77.from!=_77.at){_9(this.getParents(_77.item),_3.hitch(this,"_childrenChanged"));}break;case "close":this._onStoreClose(_77.count,_77.cleared);break;case "delete":this._onDeleteItem(_77.item);break;case "new":this._onNewItem(_77.item);break;}},onChange:function(_78,_79,_7a,_7b){},onChildrenChange:function(_7c,_7d){},onPasteItem:function(_7e,_7f,_80){},onDelete:function(_81){},onReset:function(){},onRootChange:function(_82,_83){},_childrenChanged:function(_84){var _85,_86=this;_84=_84 instanceof Array?_84:[_84];if(_84&&_84.length){_84.forEach(function(_87){_85=_86.getIdentity(_87);_86._deleteCacheEntry(_85);_86.getChildren(_87,function(_88){_86._onChildrenChange(_87,_88.slice(0));},function(err){console.error(err);});});}},_deleteCacheEntry:function(id){if(this._childrenCache[id]){var _89=this._obsHandles[id];_89&&_89.remove();delete this._childrenCache[id];delete this._obsHandles[id];}},_getChildren:function(_8a,_8b,_8c,_8d){var id=this.getIdentity(_8a);var _8e=this;var _8f=null;if(_8a&&id!=_f){if(this._observable&&this._childrenCache[id]){_9(this._childrenCache[id],_8c,_8d);return;}_8e._childrenCache[id]=_8f=_8b.call(_8e,_8a,id);if(!this._objectCache[id]){this._objectCache[id]=_3.mixin(null,_8a);}_9(_8f,function(_90){_90.forEach(function(_91){_8e._objectCache[_8e.getIdentity(_91)]=_3.mixin(null,_91);});_8e._childrenCache[id]=_90;});if(this._observable&&_8f.observe){var _92=_8f.observe(function(obj,_93,_94){if(_94==-1){_9(_8f,_3.hitch(_8e,"_onDeleteItem",obj));}else{if(_93==-1){_9(_8f,_3.hitch(_8e,"_onNewItem",obj));}else{if(_93==_94){_9(_8f,_3.hitch(_8e,"_onChange",obj,null));}else{_9(_8f,function(_95){_95=Array.prototype.slice.call(_95);});}}}},true);this._obsHandles[id]=_92;}}else{_8f=new _5();_8f.reject(new _e("ParameterMissing","_getChildren","No parent object or Id"));}_9(_8f,_8c,_8d);},_getProp:function(_96,_97){var _98=_96.split(".");var p,i=0;while(_97&&(p=_98[i++])){_97=(p in _97?_97[p]:undefined);}return _97;},_loadStore:function(_99){if(!this._loadRequested){var _9a=this._methods.ready;var _9b=this._methods.load;var _9c,_9d=this;this._loadRequested=true;this.state="loading";_9c=[_9b.call(this.store,_99),_9a.call(this.store)];this._loadPromise=_6(_9c).always(function(){return _9(_9a.call(_9d.store),function(){_9d._storeReady.resolve();_9d._validateStore().then(function(){_9d._modelReady.resolve();_9d.state="active";},function(err){_9d._modelReady.reject(err);_9d.state="in-active";});return true;},function(err){_9d._modelReady.reject(err);_9d._storeReady.reject(err);});});}return this._loadPromise;},_setProp:function(_9e,_9f,_a0){var _a1=_9e.split(".");var _a2=_a1.pop();if(_a1.length){var p,i=0;while(_9f&&(p=_a1[i++])){_9f=(p in _9f)?_9f[p]:_9f[p]={};}}_9f[_a2]=_a0;return _a0;},_setValue:function(_a3,_a4,_a5){if(_a3[_a4]!==_a5){if(this._writeEnabled){var _a6=_3.mixin(null,_a3);var _a7=null;var _a8=this;this._setProp(_a4,_a3,_a5);_a7=this.store.put(_a3,{overwrite:true});if(!this._monitored){_9(_a7,function(){_a8._onChange(_a3,_a6);});}}else{throw new _e("AccessError","_setValue","store is not writable.");}}return _a5;},_updateChildrenCache:function(_a9,_aa,_ab){var _ac=this.getIdentity(_aa);var _ad=this;return _9(this._childrenCache[_ac],function(_ae){var _af=_ae||[];var _b0=_af.indexOf(_ab);var _b1=_af.total||0;if(_a9=="add"||_a9=="attach"){if(_b0==-1){_af.push(_ab);_b1++;}}else{if(_b0>-1){_af.splice(_b0,1);_b1--;}}_af["total"]=_b1;_ad._childrenCache[_ac]=_af;return _af;});},_validateStore:function(){var _b2=new _5();return _b2.resolve();}});return _11;});