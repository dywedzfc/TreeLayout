//>>built
define("cbtree/models/TreeStoreModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/has","dojo/json","dojo/Stateful","./ItemWriteStoreEX"],function(_1,_2,_3,_4,_5,_6,_7,_8){return _2([_7],{checkedAll:true,checkedState:false,checkedRoot:false,checkedStrict:true,checkedAttr:"checked",childrenAttrs:["children"],deferItemLoadingUntilExpand:false,enabledAttr:"",excludeChildrenAttrs:null,iconAttr:"",labelAttr:"",multiState:true,newItemIdAttr:"id",normalize:true,query:null,store:null,moduleName:"cbTree/models/TreeStoreModel",hasFakeRoot:false,root:null,_checkedChildrenAttrs:null,_queryAttrs:[],_validateStore:true,_validating:0,constructor:function(_9){_2.safeMixin(this,_9);this.connects=[];var _a=this.store;if(!_a.getFeatures()["dojo.data.api.Identity"]){throw new Error(this.moduleName+"constructor(): store must support dojo.data.Identity");}_5.add("tree-model-getChecked",1);if(!_a.getFeatures()["dojo.data.api.Write"]){console.warn(this.moduleName+"::constructor(): store is not write enabled.");this._writeEnabled=false;}else{_5.add("tree-model-setChecked",1);this._writeEnabled=true;}if(_a.getFeatures()["dojo.data.api.Notification"]){this.connects=this.connects.concat([_4.after(_a,"onLoad",_3.hitch(this,"onStoreLoaded"),true),_4.after(_a,"onNew",_3.hitch(this,"onNewItem"),true),_4.after(_a,"onDelete",_3.hitch(this,"onDeleteItem"),true),_4.after(_a,"onSet",_3.hitch(this,"onSetItem"),true),_4.after(_a,"onRoot",_3.hitch(this,"onRootChange"),true)]);}this._checkedChildrenAttrs=this._diffArrays(this.childrenAttrs,this.excludeChildrenAttrs);if(this.query){var _b;for(_b in this.query){this._queryAttrs.push(_b);}}dojo.deprecated("{cbtree/models/TreeStoreModel}","Migrate to the new models in cbtree/model/","2.0");},destroy:function(){var h;while(h=this.connects.pop()){h.remove();}this.store=null;},_checkedStrictSetter:function(_c){_c=_c?true:false;if(this.checkedStrict!==_c){this.checkedStrict=_c;if(this.checkedStrict){this.getRoot(_3.hitch(this,function(_d){this.getChildren(_d,_3.hitch(this,function(_e){this._validateChildren(_d,_e);}));}));}}return this.checkedStrict;},_enabledAttrSetter:function(_f){if(_3.isString(_f)){if(this.enabledAttr!==_f){throw new Error(this.moduleName+"::set(): enabledAttr property is read-only.");}}else{throw new Error(this.moduleName+"::set(): enabledAttr value must be a string");}return this.enabledAttr;},_labelAttrGetter:function(){return this.getLabelAttr();},_labelAttrSetter:function(_10){return this.setLabelAttr(_10);},_querySetter:function(_11){if(_3.isObject(_11)){if(this.query!==_11){this.query=_11;this._requeryTop();}return this.query;}else{throw new Error(this.moduleName+"::set(): query argument must be of type object");}},getChildren:function(_12,_13,_14,_15){var _16=this.store;var _17=this;if(!_16.isItemLoaded(_12)){var _18=_3.hitch(this,arguments.callee);_16.loadItem(_17._mixinFetch({item:_12,onItem:function(_19){_18(_19,_13,_14);},onError:_14}));return;}var _1a=[],_1b,i;if(!_15){for(i=0;i<this.childrenAttrs.length;i++){_1b=_16.getValues(_12,this.childrenAttrs[i]);_1a=_1a.concat(_1b);}}else{var _1c=_3.isArray(_15)?_15:[_15];for(i=0;i<_1c.length;i++){_1b=_16.getValues(_12,_1c[i]);_1a=_1a.concat(_1b);}}var _1d=0;if(!this.deferItemLoadingUntilExpand){_1.forEach(_1a,function(_1e){if(!_16.isItemLoaded(_1e)){_1d++;}});}if(_1d==0){_13(_1a);}else{_1.forEach(_1a,function(_1f,idx){if(!_16.isItemLoaded(_1f)){_16.loadItem(_17._mixinFetch({item:_1f,onItem:function(_20){_1a[idx]=_20;if(--_1d==0){_13(_1a);}},onError:_14}));}});}},getParents:function(_21){if(_21){return this.store.getParents(_21);}},getRoot:function(_22,_23){if(this.root){_22(this.root);}else{this.store.fetch(this._mixinFetch({query:this.query,onComplete:_3.hitch(this,function(_24){if(_24.length!=1){throw new Error(this.moduleName+": query "+_6.stringify(this.query)+" returned "+_24.length+" items, but must return exactly one item");}this.root=_24[0];_22(this.root);}),onError:_23}));}},mayHaveChildren:function(_25){return _1.some(this.childrenAttrs,function(_26){return this.store.hasAttribute(_25,_26);},this);},_getCompositeState:function(_27){var _28=false,_29=false,_2a=false,_2b,_2c;_1.some(_27,function(_2d){_2c=this.getChecked(_2d);_2a|=(_2c=="mixed");switch(_2c){case true:_28=true;break;case false:_29=true;break;}return _2a;},this);if(_2a||_28||_29){_2a|=!(_28^_29);_2b=(_2a?"mixed":_28?true:false);}return _2b;},_normalizeState:function(_2e,_2f){if(typeof _2f=="boolean"){return _2f;}if(this.multiState&&_2f=="mixed"){if(this.normalize&&!this.mayHaveChildren(_2e)){return true;}return _2f;}return _2f?true:false;},_setChecked:function(_30,_31){var _32=false,_33;_33=this._normalizeState(_30,_31);_32=(_33!=_31);if(this.store.isItem(_30)){var _34=this.store.getValue(_30,this.checkedAttr);if((_34!==undefined||this.checkedAll)&&(_34!=_33||_32)){this.store.setValue(_30,this.checkedAttr,_33);return true;}}else{if(_30===this.root&&this.hasFakeRoot){if(this.checkedRoot&&((this.root[this.checkedAttr]!=_33)||_32)){this.root[this.checkedAttr]=_33;this.onChange(_30,this.checkedAttr,_33);return true;}}else{throw new TypeError(this.moduleName+"::_setChecked(): invalid item specified.");}}return false;},_updateCheckedChild:function(_35,_36){this._setChecked(_35,_36);if(this.mayHaveChildren(_35)){this.getChildren(_35,_3.hitch(this,function(_37){_1.forEach(_37,function(_38){this._updateCheckedChild(_38,_36);},this);}),this.onError,this._checkedChildrenAttrs);}},_updateCheckedParent:function(_39,_3a){if(!this.checkedStrict||!_39){return;}var _3b=this.getParents(_39),_3c=this.getChecked(_39),_3d;_1.forEach(_3b,function(_3e){if(this.isChildOf(_3e,_39)){if((_3c!==this.getChecked(_3e))||_3a){this.getChildren(_3e,_3.hitch(this,function(_3f){_3d=this._getCompositeState(_3f);if(_3d!==undefined){this._setChecked(_3e,_3d);}}),this.onError,this._checkedChildrenAttrs);}}},this);},_validateChildren:function(_40,_41,_42){var _41,_43,_44;this._validating+=1;_41=_3.isArray(_41)?_41:[_41];_1.forEach(_41,function(_45){if(this.mayHaveChildren(_45)){this.getChildren(_45,_3.hitch(this,function(_46){this._validateChildren(_45,_46,_42);}),this.onError,_42);}else{_43=this.getChecked(_45);if(_43&&typeof _43!=="boolean"){_45[this.checkedAttr]=[this._normalizeState(_45,_43)];}}},this);_44=this._getCompositeState(_41);_43=this.getChecked(_40);if(_43!==undefined&&_44!==undefined){this._setChecked(_40,_44);}this._validating-=1;if(!this._validating){this.store.setValidated(true);this.onDataValidated();}},getChecked:function(_47){var _48;if(this.excludeChildrenAttrs){if(this.isMemberOf(_47,this.excludeChildrenAttrs)){return;}}if(this.store.isItem(_47)){_48=this.store.getValue(_47,this.checkedAttr);if(_48===undefined){if(this.checkedAll){this._setChecked(_47,this.checkedState);return this.checkedState;}}}else{if(_47===this.root&&this.hasFakeRoot){if(this.checkedRoot){return this.root[this.checkedAttr];}}else{throw new TypeError(this.moduleName+"::getChecked(): invalid item specified.");}}return _48;},getEnabled:function(_49){var _4a=true;if(this.enabledAttr){if(this.store.isItem(_49)){_4a=this.store.getValue(_49,this.enabledAttr);}else{if(_49===this.root){_4a=_49[this.enabledAttr];}else{throw new TypeError(this.moduleName+"::getEnabled(): invalid item specified.");}}}return (_4a===undefined)||Boolean(_4a);},getItemState:function(_4b){return {checked:this.getChecked(_4b),enabled:this.getEnabled(_4b)};},setChecked:function(_4c,_4d){if(!this.checkedStrict){this._setChecked(_4c,_4d);}else{this._updateCheckedChild(_4c,_4d);}},setEnabled:function(_4e,_4f){if(this.enabledAttr){if(this.store.isItem(_4e)){return this.store.setValue(_4e,this.enabledAttr,Boolean(_4f));}else{if(_4e===this.root){return this.root[this.enabledAttr]=Boolean(_4f);}else{throw new TypeError(this.moduleName+"::setEnabled(): invalid item specified.");}}}},validateData:function(){if(this.checkedStrict){if(!this.store.isValidated()){this.store.loadStore({onComplete:function(_50){if(_5("tree-model-setChecked")){if(this._validateStore){this.getRoot(_3.hitch(this,function(_51){this.getChildren(_51,_3.hitch(this,function(_52){this._validateChildren(_51,_52,this._checkedChildrenAttrs);}),this.onError);}),this.onError);}}else{console.warn(this.moduleName+"::validateData(): store is not write enabled.");}},onError:function(err){},scope:this});}else{if(this.hasFakeRoot){this.getChildren(this.root,_3.hitch(this,function(_53){this._updateCheckedParent(_53[0],true);}),this.onError,this._checkedChildrenAttrs);}this.onDataValidated();}}else{this.store.setValidated(false);}},fetchItemByIdentity:function(_54){this.store.fetchItemByIdentity(_54);},getIcon:function(_55){if(this.iconAttr){return this.store.getValue(_55,this.iconAttr);}},getIdentity:function(_56){return this.store.getIdentity(_56);},getLabel:function(_57){if(this.labelAttr){return this.store.getValue(_57,this.labelAttr);}else{this.setLabelAttr(this.getLabelAttr());return this.store.getLabel(_57);}},isItem:function(_58){return this.store.isItem(_58);},isTreeRootChild:function(_59){if(this.root){return this.isChildOf(this.root,_59);}},isChildOf:function(_5a,_5b){var i;for(i=0;i<this.childrenAttrs.length;i++){if(_1.indexOf(_5a[this.childrenAttrs[i]],_5b)!==-1){return true;}}return false;},isMemberOf:function(_5c,_5d){if(this.isItem(_5c)){var _5e=this.getParents(_5c);var _5f=_5d?(_3.isArray(_5d)?_5d:[_5d]):[];var _60=false;var i;_1.some(_5e,function(_61){for(i=0;i<_5f.length;i++){if(_1.indexOf(_61[_5f[i]],_5c)!=-1){return (_60=true);}}},this);}return _60;},deleteItem:function(_62){return this.store.deleteItem(_62);},newItem:function(_63,_64,_65,_66){var _67={parent:_64,attribute:(_66?_66:this.childrenAttrs[0])},_68;this._mapIdentifierAttr(_63,false);try{_68=this.store.itemExist(_63);if(_68){this.pasteItem(_68,null,_64,true,_65);}else{_68=this.store.newItem(_63,_67);if(_68&&(_65!=undefined)){this.pasteItem(_68,_64,_64,false,_65);}}}catch(err){throw new Error(this.moduleName+"::newItem(): "+err);}return _68;},pasteItem:function(_69,_6a,_6b,_6c,_6d,_6e){var _6f=_6e?_6e:this.childrenAttrs[0],_70=this.store,_71;if(_6a){_1.forEach(this.childrenAttrs,function(_72){if(_70.containsValue(_6a,_72,_69)){if(!_6c){_70.removeReference(_69,_6a,_72);}_6f=_72;}},this);}if(_6b){_70.addReference(_69,_6b,_6f,_6d);}},getLabelAttr:function(){if(!this.labelAttr){var _73=this.store.getLabelAttributes();if(_73){this.setLabelAttr(_73[0]);}}return this.labelAttr;},setLabelAttr:function(_74){if(_3.isString(_74)&&_74.length){if(this.labelAttr!==_74){var _75=this.labelAttr;this.labelAttr=_74;this.onLabelChange(_75,_74);}return this.labelAttr;}},onChange:function(){},onChildrenChange:function(){},onDataValidated:function(){},onDelete:function(){},onLabelChange:function(){},onNewItem:function(_76,_77){if(_77){this.getChildren(_77.item,_3.hitch(this,function(_78){this.onChildrenChange(_77.item,_78);}));}this._updateCheckedParent(_76,true);},onDeleteItem:function(_79){this.onDelete(_79);},onError:function(err){console.error(this,err);},onSetItem:function(_7a,_7b,_7c,_7d){if(_1.indexOf(this.childrenAttrs,_7b)!=-1){this.getChildren(_7a,_3.hitch(this,function(_7e){if(_7e[0]){this._updateCheckedParent(_7e[0],true);}else{this._setChecked(_7a,this.checkedState);}this.onChildrenChange(_7a,_7e);}));}else{if(_7b==this.checkedAttr){this._updateCheckedParent(_7a,false);}this.onChange(_7a,_7b,_7d);}},onStoreLoaded:function(_7f){this.getLabelAttr();},onRootChange:function(_80,_81){},_mapIdentifierAttr:function(_82,_83){var _84=this.store.getIdentifierAttr();if(_84){if(!_82[_84]&&(this.newItemIdAttr&&_82[this.newItemIdAttr])){_82[_84]=_82[this.newItemIdAttr];if(_83){delete _82[this.newItemIdAttr];}return true;}}if(this.checkedAll&&_82[this.checkedAttr]===undefined){_82[this.checkedAttr]=this.checkedState;}return false;},_diffArrays:function(_85,_86){var _87=_86?(_3.isArray(_86)?_86:[_86]):[];var _88=_85.slice(0);var _89,i;if(_88.length&&_87.length){for(i=0;i<_87.length;i++){_89=_1.indexOf(_88,_87[i]);if(_89!=-1){_88.splice(_89,1);}}}return _88;},_mixinFetch:function(_8a){return _8a;}});});