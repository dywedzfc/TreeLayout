//>>built
define("cbtree/store/Memory",["module","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/request","dojo/Stateful","dojo/request/handlers","dojo/store/util/QueryResults","../errors/createError!../errors/CBTErrors.json","../util/QueryEngine","../util/shim/Array"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){var _b=_9(_1.id);var _c;function _d(_e){if(_e.response){switch(_e.response.status){case 404:_e.message=_e.response.url.match(/[^?#]*/)[0];_e.name="NotFoundError";}}return _e;};function _f(_10){throw new _b("ReadOnly","set","property ["+_10+"] is READ-ONLY");};var _11=_2([_6],{autoLoad:true,clearOnClose:false,data:null,dataHandler:null,defaultProperties:null,filter:null,handleAs:null,idProperty:"id",queryEngine:_a,url:null,state:"closed",total:0,_indexStore:true,constructor:function(_12){var _13=this;this._loadDeferred=new _4(this._loadReset);this._storeReady=new _4();this._loadPending=false;this._data=[];this._indexId={};this.state="waitOnLoad";this.total=0;_2.safeMixin(this,_12);if(this.handleAs&&this.dataHandler){var _14=this.dataHandler.handler||this.dataHandler;var _15=this.dataHandler.options;var _16,_17;switch(typeof _14){case "function":_14=new _14();if(typeof _14.handler!="function"){_17=this.dataHandler;_14=undefined;break;}case "object":_17=_14.handler;_16=_14.set;break;default:throw new _b("InvalidType","constructor","handler must be a function");}if(_17){_7.register(this.handleAs,(_14?_3.hitch(_14,_17):_17));if(_14&&_15){_16?_16.call(_14,_15):_3.mixin(_14,_15);}}}if(!this.data&&!this.url&&this.autoLoad){this.set("data",[]);}},destroy:function(){this._data.forEach(function(_18){_18._destoyed=true;});this._destroyed=true;this._indexId={};this._data=[];},_autoLoadSetter:function(_19){this.autoLoad=!!_19;},_dataSetter:function(_1a){if(this.autoLoad){this.load({data:_1a});}else{this.data=_1a;}},_eventableSetter:function(){_f("eventable");},_hierarchicalSetter:function(){_f("hierarchical");},_idPropertySetter:function(_1b){this._indexStore=!!_1b;this.idProperty=_1b;},_urlSetter:function(url){if(typeof url=="string"){if(this.autoLoad){this.load({url:url});}else{this.url=url;}}else{throw new _b("InvalidType","_urlSetter","URL property must be of type string");}},_anyToObject:function(_1c,_1d){if(_1c){var _1d=_1d||false;var _1e;switch(typeof _1c){case "string":case "number":_1e=_1c;break;case "object":if(_1d){if(!this.isItem(_1c)){throw new _b("InvalidObject","_anyToObject");}return _1c;}_1e=this.getIdentity(_1c);break;default:return;}return this.get(_1e);}},_applyDefaults:function(id,_1f){if(this.defaultProperties){for(var _20 in this.defaultProperties){_1f[_20]=_1f[_20]||this.defaultProperties[_20];}}if(this.idProperty){_1f[this.idProperty]=id;}},_getObjectId:function(_21,_22){var id;if(_22&&"id" in _22){id=_22.id;}else{id=this.getIdentity(_21);}if(id===null||id===_c){id=Math.random();}return id;},_indexData:function(){if(this._indexStore){var _23=this.idProperty;var _24=this._indexId={};var _25=this._data;var i;for(i=0;i<_25.length;i++){_24[_25[i][_23]]=i;}}},_loadError:function(err,_26){this._loadReset(err);_26.reject(new _b(_d(err),"load"));return _26.promise;},_loadData:function(_27,_28){if(!_28.isFulfilled()){var _29,id,i;var _2a=this;var at;this._indexId={};this._data=[];this.data=null;_27=_27||[];if(_27 instanceof Array){try{for(i=0;i<_27.length;i++){_29=_27[i];id=this._getObjectId(_29);at=this._indexId[id]||-1;if(at>=0){console.warn(new _b("ItemExist","_loadData","Object with ID: ["+id+"] already exist"));}else{this._writeObject(id,_29,at);}}this._indexData();this._storeReady.resolve(true);this.state="active";_28.resolve(true);}catch(err){_2a._loadError(err,_28);}}else{_2a._loadError(new _b("InvalidData","_loadData"),_28);}this._loadPending=false;}return _28.promise;},_loadReset:function(){this._loadDeferred=new _4(this._loadReset);this._loadPending=false;this.handleAs=null;this.data=null;this.url=null;this.state="closed";},_writeObject:function(id,_2b,_2c,_2d){if(_2c>-1){this._data[_2c]=_2b;}else{this._applyDefaults(id,_2b);if(this._indexStore){this._indexId[id]=this._data.push(_2b)-1;}else{this._data.push(_2b);}this.total=this._data.length;}return id;},_xhrGet:function(url,_2e){return _5(this.url,{method:"GET",handleAs:_2e,preventCache:true});},add:function(_2f,_30){var id=this._getObjectId(_2f,_30);var at=this._indexId[id];if(at>=0){throw new _b("ItemExist","add");}return this._writeObject(id,_2f,at,_30);},close:function(_31){if(!this._loadDeferred.isFulfilled()){this._loadDeferred.then(null,function _final(){});this._loadDeferred.cancel(new _b("RequestCancel","close","load request was canceled"));}if(this._storeReady.isFulfilled()){this._storeReady=new _4();}var _32=!!(_31||this.clearOnClose);if(!!_32){this._loadReset();this._indexId={};this._data=[];this.total=0;}this.onClose(_32,this.total);},get:function(id){return this._data[this._indexId[id]];},getIdentity:function(_33){if(_33&&this.idProperty){return _33[this.idProperty];}},isItem:function(_34){if(_34&&typeof _34=="object"){return (_34==this.get(this.getIdentity(_34)));}return false;},load:function(_35){var _36=["data","filter","handleAs","url"];var _37=this._loadDeferred;if(!this._loadPending&&!_37.isFulfilled()){if(_35){for(var key in _35){if(_36.indexOf(key)!=-1){this[key]=_35[key];}}}if(this.data||this.url){var _38=this.filter?_a(this.filter):function(_39){return _39;};var _3a=this;this.state="loading";this._loadPending=true;if(this.data){try{if(this.handleAs){var _3b={text:this.data,options:{handleAs:this.handleAs}};this.data=_7(_3b).data;}this._loadData(_38(this.data),_37);}catch(err){return _3a._loadError(err,_37);}this.url=null;}else{if(!this.handleAs){this.handleAs="json";}var _3c=this._xhrGet(this.url,this.handleAs,null);_3c.then(function(_3d){_3a._loadData(_38(_3d),_37);},function(err){_3a._loadError(err,_37);});}}}else{if(_35){if(_35.url||_35.data){var def=new _4();if(this._loadPending){return def.reject(new _b("RequestPending","load"));}return def.reject(new _b("Access","load","store already loaded"));}}}return _37.promise;},put:function(_3e,_3f){var id=this._getObjectId(_3e,_3f);var at=this._indexId[id];if(at>=0){if(_3f&&_3f.overwrite===false){throw new _b("ItemExist","put");}}return this._writeObject(id,_3e,at,_3f);},query:function(_40,_41){var _42=this;return _8(this._storeReady.then(function(){return _42.queryEngine(_40,_41)(_42._data,false);}));},ready:function(_43,_44,_45){if(_43||_44){return this._storeReady.then(_43?_3.hitch((_45||this),_43):null,_44?_3.hitch((_45||this),_44):null);}return this._storeReady.promise;},remove:function(id){var at=this._indexId[id];if(at>=0){this._data.splice(at,1);this._indexData();this.total=this._data.length;return true;}return false;},toString:function(){return "[object MemoryStore]";},onClose:function(){}});return _11;});