//>>built
define("cbtree/store/FileStore",["module","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/Evented","dojo/json","dojo/request","dojo/Stateful","dojo/store/util/QueryResults","dojo/when","../errors/createError!../errors/CBTErrors.json","../util/Mutex","../util/QueryEngine","../util/shim/Array"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){"use strict";var _e=_b(_1.id);var _f="cbTree/store/FileStore";var _10="_EX";var _11="path";var _12="icon";var _13;function _14(_15){if(_15.response){switch(_15.response.status){case 404:_15.message="404 Object Not Found";_15.name="NetworkError";}}};function _16(_17){var idx=_17.lastIndexOf("/");if(idx!=-1){return _17.slice(0,idx);}};function _18(_19){var icc;if(_19.directory){icc="fileIconDIR";}else{var _1a=_19.name.lastIndexOf(".");if(_1a>0){var ext=_19.name.substr(_1a+1).toLowerCase();ext=ext.replace(/[a-z]/,function(c){return c.toUpperCase();});icc="fileIcon"+ext;}else{icc="fileIconUnknown";}}_19[_12]=icc+" fileIcon";};var _1b=_2([_5,_8],{autoLoad:false,authToken:null,basePath:".",defaultProperties:{},options:[],preventCache:false,sort:[],queryEngine:_d,url:"",_localOptions:["iconClass","dirsOnly"],_rootName:".",_reservedProp:["name","size","modified","directory","icon",_11],constructor:function(_1c){this._loaded=new _4();this._loadInProgress=false;this._storeLoaded=false;this._mutex=new _c();this._childIndex={};this._primIndex={};this._data=[];},_basePathSetter:function(_1d){if(typeof _1d==="string"){var _1e=_1d.replace(/\\/g,"/").split("/");_1e=_1e.filter(function(_1f){return (!!_1f.length&&_1f!=".");});_1e.unshift(".");this.basePath=_1e.join("/");}else{throw new _e("InvalidType","basePathSetter","basePath property must be a string");}},_dataSetter:function(){throw new _e("InvalidAccess","_dataSetter","data property is not allowed");},_defaultPropertiesSetter:function(_20){if(_20&&_3.isObject(_20)){for(var _21 in _20){if(this._reservedProp.indexOf(_21)!=-1){throw new _e("InvalidAccess","_defaultPropertiesSetter","No default allowed for property '"+_21+"'");}}}else{throw new _e("InvalidType","_defaultPropertiesSetter","defaultProperties must be an object");}},_sortSetter:function(_22){_22=_22 instanceof Array?_22:[_22];_22.forEach(function(_23){if(_3.isObject(_23)){if(!("attribute" in _23)){throw new _e("PropertyMissing","_sortSetter","[attribute] property missing in sort object");}}else{throw new _e("InvalidType","_sortSetter","sort property must be an Array of objects");}});this.sort=_22;return _22;},_optionsSetter:function(_24){if(!(_24 instanceof Array)){if(typeof _24!=="string"){throw new _e("InvalidType","_optionSetter","Options must be a keyword string"+" or an array of keywords.");}else{_24=_24.split(",");}}this.options=_24.filter(function(_25){if(this._localOptions.indexOf(_25)!=-1){var _26="_option"+_25.replace(/[a-z]/,function(c){return c.toUpperCase();});this[_26]=true;return false;}return true;},this);return this.options;},_urlSetter:function(_27,_28){var _28=!!(_28||this.autoLoad);if(typeof _27==="string"){this._url=_27;if(this._url&&_28===true){this.load();}return this._url;}else{throw new _e("InvalidType","_urlSetter","URL must be of type string");}},_deleteFromStore:function(_29){var _2a=_29.items;var _2b=this._primIndex;var _2c=this._childIndex;var _2d=this._data;var _2e=this;var i;function _2f(id){var _30=_2d[_2b[id]];var _31,idx;if(_30){if(_31=_2c[_30.parent]){if((idx=_31.indexOf(_30))!=-1){_31.splice(idx,1);}}}};function _32(_33){if(_33.directory){if(_33.children){_33.children.forEach(_32);}_33[_10]=false;}var id=_2e.getIdentity(_33);_2f(id);delete _2d[_2b[id]];delete _2c[id];};if(_2a&&_2a.length){return this._mutex.aquire(function(){_2a.forEach(_32);this._data=_2d.filter(function(){return true;});this._primIndex={};for(i=0;i<this._data.length;i++){this._primIndex[this._data[i][_11]]=i;}this._mutex.release(true);},this);}return new _4().resolve(false);},_fetchFromServer:function(_34,_35,_36){var _36=_36||new _4();var _37={path:_34};var _38=this;var _39;if(_35){_37.queryOptions=_35;}_39=this._xhrRequest("GET",this._url,_37);_39.then(function(_3a){_a(_38._updateFileStore(_3a),_36.resolve,_36.reject);},function(err){_14(err);_36.reject(err);});return _36;},_fetchFromStore:function(id){return this._data[this._primIndex[id]];},_resyncStore:function(_3b){var _3c={total:1,status:200,items:[]};var _3d=_3b.parent;var _3e=this;function _3f(_40){if(_40.directory){_40.children=_3e._childIndex[_3e.getIdentity(_40)];_40.children.forEach(function(_41){_3f(_41);});}return _40;};_3c.items.push(_3f(_3b));this._deleteFromStore(_3c);var _42=this._fetchFromServer(_3d);_42.then(null,function(_43){switch(_43.response.status){case 404:case 410:_3e.remove(_3d);break;}});},_updateFileStore:function(_44){var _45=[];var _46=this;function _47(_48,_49){var _4a,_4b;if(_48){_48.forEach(function(_4c){_4a=_46.getIdentity(_4c);_4b=_49.some(function(_4d){return _4a===_46.getIdentity(_4d);});if(!_4b){_46.remove(_4a,true);}});}};function _4e(_4f,_50){var _51=_46.getIdentity(_4f);var _52=_46._fetchFromStore(_51);var _53=_4f.children;var _54=_16(_4f.path);var _55;var _56;function _57(_58){var _59=_46._childIndex[_58.parent]||[];if(_59.indexOf(_58)==-1){_59.push(_58);_46._childIndex[_58.parent]=_59;}};_4f.parent=_54;delete _4f.children;delete _4f.oldPath;if(_52){if(_52.directory&&_4f[_10]){_47(_46._childIndex[_51],_53);}_4f=_3.mixin(_52,_4f);}else{for(_55 in _46.defaultProperties){_4f[_55]=_4f[_55]||_46.defaultProperties[_55];}if(_46._optionIconClass){_18(_4f);}}if(_52){_56=_46._primIndex[_51];_46._data[_56]=_4f;}else{_56=_46._data.push(_4f)-1;_46._primIndex[_51]=_56;}_57(_4f);if(_46._storeLoaded&&_50){if(!_52){_46._data[_56]=_3.delegate(_4f,{_placeHolder:true});}_46.put(_4f,{overwrite:true,_server:true});}if(_53){_53.forEach(function(_5a){_4e(_5a,false);});}return _4f;};if(_44&&_44.items){var _5b=_44.items;return this._mutex.aquire(function(){_5b.forEach(function(_5c){if(_46.getIdentity(_5c)){_45.push(_4e(_5c,true));}else{}});this._mutex.release(_45);},this);}throw new _e("InvalidResponse","_updateFileStore");},_xhrRequest:function(_5d,url,_5e){var _5f={method:_5d,preventCache:this.preventCache,handleAs:"json"};var _5e=_3.mixin(_5e,{authToken:this.authToken,basePath:this.basePath});var _60="";var _61=this;var key,_62;switch(_5d){case "POST":var _63={basePath:this.basePath,path:_5e.path,newValue:_5e.newValue};_5f.data=_63;break;case "GET":_5e.options=this.options;case "DELETE":for(key in _5e){if(_62=_5e[key]){if(_62 instanceof Array&&!_62.length){continue;}_60+="&"+key+"="+_6.stringify(_62);}}break;}if(_60.length){_5f.query=_60;}var _64=_7(url,_5f);return _64;},add:function(_65,_66){throw new _e("InvalidAccess","add","operation not allowed, use get() and put() instead");},get:function(id,_67){var _68=this._data[this._primIndex[id]];if(!_68&&!_67){if(!this._loadInProgress){var _69=this._fetchFromServer(id,this.options);return _69.promise;}else{}}else{if(_68&&_68._placeHolder){return new _4().reject(new _e("NotFound","get"));}}return new _4().resolve(_68);},getChildren:function(_6a,_6b){var _6c=this.getIdentity(_6a);var _6d={parent:_6c};var _6e=this;var _6f=[];if(this.sort){if(_6b){_6b.sort=_6b.sort||this.sort;}else{_6b={sort:this.sort};}}if(_6c&&_6a.directory){if(!_6a[_10]){_6f=_6e._fetchFromServer(_6c);return _6f.then(function(){return _6e.query(_6d,_6b,_6e._childIndex[_6c]);},function(err){switch(err.response.status){case 404:case 410:_6e._resyncStore(_6a);break;default:return err;}return _6e.query(_6d,_6b,_6e._childIndex[_6c]);});}return _6e.query(_6d,_6b,_6e._childIndex[_6c]);}return _9(_6f);},getIdentity:function(_70){return _70[_11];},isItem:function(_71){if(_71&&typeof _71=="object"){return (_71==this.get(this.getIdentity(_71)));}return false;},load:function(_72){var _73={deep:(_72?!!_72.all:false)};var _74=this._loaded;var _75=this;if(!this._storeLoaded&&!this._loadInProgress){this._loadInProgress=true;_74=this._fetchFromServer(null,_73,this._loaded);_74.then(function(_76){_75.emit("load",{type:"load",store:_75});_75._loadInProgress=false;_75._storeLoaded=true;},function(err){_75.emit("error",{type:"load",error:err,store:_75});});}return _74.promise;},put:function(_77,_78){var id=this.getIdentity(_77);if(id){var _79=this._primIndex;var _7a=this._data;if(id in _79){_7a[_79[id]]=_77;}else{if(_78&&_78._server===true){_79[id]=_7a.push(_77)-1;}else{throw new _e("NotFound","put");}}return id;}throw new _e("InvalidObject","put");},query:function(_7b,_7c,_7d){var _7b=_7b||{name:this._rootName};var _7e=_7d!=_13?_7d:this._data;var _7f=this;if(this._optionDirsOnly&&!_7b.directory){_7b.directory=true;}if(this.sort){if(_7c){_7c.sort=_7c.sort||this.sort;}else{_7c={sort:this.sort};}}if(!this._storeLoaded){if(!this._loadInProgress){this.loadStore();}return _a(this._loaded,function(){return _9(_7f.queryEngine(_7b,_7c)(_7e));});}return _9(_7f.queryEngine(_7b,_7c)(_7e));},ready:function(_80,_81){return this._loaded.then(_80,_81);},remove:function(id,_82){var _83=new _4();var _84=this;this.get(id).then(function(_85){if(!_82){var _86=_84._xhrRequest("DELETE",_84._url,{path:_85.path});}else{var _86=new _4().resolve({total:1,status:200,items:[_85]});}_86.then(function(_87){_a(_84._deleteFromStore(_87),_83.resolve,_83.reject);},function(err){switch(err.response.status){case 404:case 410:_84._resyncStore(_85);_83.resolve(false);break;default:_83.reject(err);break;}});},_83.reject);return _83.promise;},rename:function(_88,_89){var _8a=new _4();var _8b=this;if(_89&&typeof _89==="string"){var _8c=this.getIdentity(_88);this.get(_8c).then(function(_8d){var _8e=_8b._xhrRequest("POST",_8b._url,{path:_8d.path,newValue:_89});_8e.then(function(_8f){_8b._updateFileStore(_8f);_8b.remove(_8c,true);_8a.resolve(_89);},function(err){switch(err.response.status){case 404:case 410:_8b._resyncStore(_8d);_8a.reject(new _e("NotFound","rename","Object nolonger exist"));break;default:_8a.reject(err);break;}});},_8a.reject);return _8a.promise;}return _8a.reject(new _e("InvalidPath","rename"));}});return _1b;});