//>>built
define("cbtree/store/Hierarchy",["module","dojo/_base/declare","dojo/_base/lang","dojo/store/util/QueryResults","./Natural","../errors/createError!../errors/CBTErrors.json"],function(_1,_2,_3,_4,_5,_6){var _7=_6(_1.id);var _8;var _9=_2([_5],{indexChildren:true,multiParented:"auto",parentProperty:"parent",hierarchical:true,_indexParent:{},_indexChild:{},constructor:function(){this.indexChildren=this._indexStore?this.indexChildren:false;},destroy:function(){this._indexParent={};this._indexChild={};this.inherited(arguments);},_getParentArray:function(_a){var _b=_a[this.parentProperty];return (_b!=_8?(this.multiParented?_b:[_b]):[]);},_getParentIds:function(_c,_d){var _e=[];if(_d){_d=(_d instanceof Array?_d:[_d]);_d.forEach(function(_f){switch(typeof _f){case "object":_f=this.getIdentity(_f);case "string":case "number":if(_f!=_8){if(_f!=_c&&_e.indexOf(_f)==-1){_e.push(_f);}}break;default:throw new _7("InvalidType","_getParentId");}},this);}return _e;},_loadData:function(_10){this._indexParent={};this._indexChild={};if(_10 instanceof Array&&this.multiParented=="auto"){this.multiParented=_10.some(function(_11){return (_11[this.parentProperty] instanceof Array);},this);}this.inherited(arguments);},_parentIdsChanged:function(_12,_13){if(_12.length==_13.length){return !_13.every(function(_14){return (_12.indexOf(_14)!=-1);});}return true;},_setParentType:function(_15){if(this.multiParented===true){if(!(_15 instanceof Array)){_15=(_15?[_15]:[]);}}else{if(this.multiParented===false){if(_15 instanceof Array){_15=(_15.length?_15[0]:_8);}}else{if(this.multiParented==="auto"){this.multiParented=(_15 instanceof Array);}}}return _15;},_updateHierarchy:function(_16,_17,_18){if(!this.indexChildren){return;}var _19=this.getIdentity(_16);var _1a=this._indexParent[_19]||[];var _1b=this._getParentArray(_16);var _1c=this._parentIdsChanged(_1b,_1a);if(_1c){_1a.forEach(function(_1d){if(_1b.indexOf(_1d)==-1){var _1e=this._indexChild[_1d];var _1f=_1e.indexOf(_16);if(_1f>-1){_1e.splice(_1f,1);if(_1e.length==0){delete this._indexChild[_1d];}}}},this);}if(_1c||_17){_1b.forEach(function(_20){var _21=this._indexChild[_20]||[];if(_17){this._insertBefore(_21,_16,_17);}else{if(_21.indexOf(_16)==-1){_21.push(_16);}}this._indexChild[_20]=_21;},this);this._indexParent[_19]=_1b.slice(0);if(!_1b.length){delete this._indexParent[_19];}}},_validParents:function(_22){var _23=this._getParentArray(_22);return _23.every(function(_24){return this._indexId[_24];},this);},_writeObject:function(id,_25,_26,_27){var _28,_29;if(_27){if(_27.parent){_25[this.parentProperty]=this._getParentIds(id,_27.parent);}if(_27.before){_28=this._anyToObject(_27.before);}}_25[this.parentProperty]=this._setParentType(_25[this.parentProperty]);_29=this.inherited(arguments);this._updateHierarchy(_25,_28);return _29;},addParent:function(_2a,_2b){var _2c=this.getIdentity(_2a);var _2d=this._getParentIds(_2c,_2b);if(_2d.length){var _2e=_3.clone(_2a);var _2f=this._getParentArray(_2e);_2d.forEach(function(id){if(_2f.indexOf(id)==-1){_2f.unshift(id);}});_2e[this.parentProperty]=this._setParentType(_2f);this.put(_2e);return true;}return false;},close:function(_30){var _31=_30||this.clearOnClose;if(!!_31){this._indexParent={};this._indexChild={};}this.inherited(arguments);},getChildren:function(_32,_33){var _34=this.getIdentity(_32);var _35={};var _36;if(this.indexChildren){var _37=this._indexChild[_34]||[];var _36=_37.slice(0);}_35[this.parentProperty]=_34;return this.query(_35,_33,_36);},getParents:function(_38){if(_38){var _39=this._getParentArray(_38);var _3a=[];_39.forEach(function(_3b){var _3c=this.get(_3b);if(_3c){_3a.push(_3c);}},this);return _3a;}},hasChildren:function(_3d){var _3e=this.getIdentity(_3d);if(this.indexChildren){var _3f=this._indexChild[_3e]||[];return !!_3f.length;}else{return this._data.some(function(_40){var _41=this._getParentArray(_40);return (_41.indexOf(_3e)!=-1);},this);}},query:function(_42,_43){var _44=(arguments.length==3?arguments[2]:null);var _45=_44||this._data;var _46=this;if(this._loadDeferred.isFulfilled()||_44){return _4(this.queryEngine(_42,_43)(_45,!!_44));}else{return _4(this._loadDeferred.then(function(){return _46.queryEngine(_42,_43)(_46._data,false);}));}},remove:function(id){var at=this._indexId[id];if(at>=0){var _47=this._data[at];var _48=_47[this.parentProperty];_47[this.parentProperty]=_8;this._updateHierarchy(_47,null);this._data.splice(at,1);this._indexData();_47[this.parentProperty]=_48;return true;}return false;},removeParent:function(_49,_4a){var _4b=this.getIdentity(_49);var _4c=this._getParentIds(_4b,_4a);if(_4c.length){var _4d=_3.clone(_49);var _4e=this._getParentArray(_4d);_4e=_4e.filter(function(id){return (_4c.indexOf(id)==-1);});_4d[this.parentProperty]=this._setParentType(_4e);this.put(_4d);return true;}return false;},toString:function(){return "[object HierarchyStore]";}});return _9;});