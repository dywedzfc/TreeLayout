//>>built
define("dgrid/TouchScroll",["dojo/_base/declare","dojo/dom-construct","dojo/dom-class","dojo/on","./util/touch","./util/has-css3"],function(_1,_2,_3,on,_4,_5){var _6=50,_7=30,_8={},_9={},_a=1,_b=8,_c=/^translate(?:3d)?\((-?\d+)(?:\.\d*)?(?:px)?, (-?\d+)/,_d=/^matrix\(1, 0, 0, 1, (-?\d+)(?:\.\d*)?(?:px)?, (-?\d+)/,_e=_5("css-transitions"),_f=_5("transitionend"),_10=_5("css-transforms"),_11=_5("css-transforms3d"),_12,_13,_14,_15,_16;if(_11){_15="translate3d(";_16=",0)";}else{if(_10){_15="translate(";_16=")";}}if(!_e||!_15){console.warn("CSS3 features unavailable for touch scroll effects.");return function(){};}_14=_11||_10;_14=_14===true?"transform":_14+"Transform";_13=_e===true?"transition":_e+"Transition";_12=_10===true?"":"-"+_10.toLowerCase()+"-";function _17(_18,_19){var _1a=_18.touchNode,_1b=_1a.parentNode,_1c=_1b.offsetWidth-_b,_1d=_1b.offsetHeight-_b,_1e=_19.scrollWidth=_1a.scrollWidth,_1f=_19.scrollHeight=_1a.scrollHeight,_20=_19.parentWidth=_1b.offsetWidth,_21=_19.parentHeight=_1b.offsetHeight,_22;if(_1e>_20){if(!_18._scrollbarXNode){_22=_2.create("div",{className:"touchscroll-x"},_1b);}_22=_18._scrollbarXNode=_18._scrollbarXNode||_2.create("div",{className:"touchscroll-bar"},_22);_22.style.width=_1c*_1c/_1e+"px";_22.style.left=_1a.offsetLeft+"px";_3.add(_1b,"touchscroll-scrollable-x");_19.scrollableX=true;}else{_3.remove(_1b,"touchscroll-scrollable-x");}if(_1f>_21){if(!_18._scrollbarYNode){_22=_2.create("div",{className:"touchscroll-y"},_1b);}_22=_18._scrollbarYNode=_18._scrollbarYNode||_2.create("div",{className:"touchscroll-bar"},_22);_22.style.height=_1d*_1d/_1f+"px";_22.style.top=_1a.offsetTop+"px";_3.add(_1b,"touchscroll-scrollable-y");_19.scrollableY=true;}else{_3.remove(_1b,"touchscroll-scrollable-y");}_3.remove(_1b,"touchscroll-fadeout");};function _23(_24,_25){var _26=_24.touchNode,_27=_8[_24.id],pos,_28,_29,x,y;if(typeof _25!=="object"){x=_25;y=arguments[2];_25=arguments[3];_28=_29=true;}else{_28="x" in _25;_29="y" in _25;if(!_28||!_29){pos=_24.getScrollPosition();}x=_28?_25.x:pos.x;y=_29?_25.y:pos.y;}_26.style[_14]=_15+-x+"px,"+-y+"px"+_16;if(_27&&_28&&_24._scrollbarXNode){_24._scrollbarXNode.style[_14]=_15+(x*_27.parentWidth/_27.scrollWidth)+"px,0"+_16;}if(_27&&_29&&_24._scrollbarYNode){_24._scrollbarYNode.style[_14]=_15+"0,"+(y*_27.parentHeight/_27.scrollHeight)+"px"+_16;}on.emit(_24.touchNode.parentNode,"scroll",{scrollLeft:x,scrollTop:y});};function _2a(_2b){if(_8[_2b.id]){return _d.exec(window.getComputedStyle(_2b.touchNode)[_14]);}return _c.exec(_2b.touchNode.style[_14]);};function _2c(_2d){var _2e=this.widget,_2f=[this.node,_2e._scrollbarXNode,_2e._scrollbarYNode],i=_2f.length;if(this.timer){clearTimeout(this.timer);this.timer=null;}if(this.transitionHandler){this.transitionHandler.remove();}while(i--){if(_2f[i]){_2f[i].style[_13+"Duration"]="0";}}if(!_2d||!_2d.preserveScrollbars){_3.add(this.node.parentNode,"touchscroll-fadeout");}delete this.resetEffects;};function _30(evt){var _31=evt.widget,_32=_31.touchNode,id=_31.id,_33=0,_34=0,_35,_36,_37;if(_4.countCurrentTouches(evt,_32)!==_31.touchesToScroll){return;}_36=_2a(_31);if(_36){_33=+_36[1];_34=+_36[2];}if((_37=_8[id])){if(_37.resetEffects){_37.resetEffects({preserveScrollbars:true});}_32.style[_14]=_15+_33+"px,"+_34+"px"+_16;_9[id]=_37;}_35=evt.targetTouches[0];_37=_8[id]={widget:_31,node:_32,startX:_33-_35.pageX,startY:_34-_35.pageY,lastX:_33,lastY:_34,pageX:_35.pageX,pageY:_35.pageY,tickFunc:function(){_38(id);}};_37.timer=setTimeout(_37.tickFunc,_6);};function _39(evt){var _3a=evt.widget,id=_3a.id,_3b=_3a.touchesToScroll,_3c=_8[id],_3d,_3e,_3f,nx,ny,_40,_41,i;if(!_3c||(_3d=_4.countCurrentTouches(evt,_3a.touchNode))!==_3b){if(_3d>_3b){_3a.cancelTouchScroll();}return;}_3e=evt.targetTouches;_3f=_3e[0];if(!_3c.scrollbarsShown){if(_9[id]||(Math.abs(_3f.pageX-_3c.pageX)>_3a.scrollThreshold||Math.abs(_3f.pageY-_3c.pageY)>_3a.scrollThreshold)){_17(_3a,_3c);_3c.scrollbarsShown=true;for(i=_3e.length;i--;){_3e[i].touchScrolled=true;}}}if(_3c.scrollbarsShown&&(_3c.scrollableX||_3c.scrollableY)){evt.preventDefault();nx=_3c.scrollableX?_3c.startX+_3f.pageX:0;ny=_3c.scrollableY?_3c.startY+_3f.pageY:0;_40=_3c.scrollableX?-(_3c.scrollWidth-_3c.parentWidth):0;_41=_3c.scrollableY?-(_3c.scrollHeight-_3c.parentHeight):0;if(nx>0){nx=nx/2;}else{if(nx<_40){nx=_40-(_40-nx)/2;}}if(ny>0){ny=ny/2;}else{if(ny<_41){ny=_41-(_41-ny)/2;}}_23(_3a,-nx,-ny);}};function _42(evt){var _43=evt.widget,id=_43.id,_44=_8[id];if(!_44||_4.countCurrentTouches(evt,_43.touchNode)!==_43.touchesToScroll-1){return;}_45(id);};function _38(id){var _46=_8[id],_47,_48,x,y;if(!_46){return;}_47=_46.node;_48=_c.exec(_47.style[_14]);if(_48){x=+_48[1];y=+_48[2];_46.velX=x-_46.lastX;_46.velY=y-_46.lastY;_46.lastX=x;_46.lastY=y;}else{_46.lastX=_46.lastY=0;}_46.timer=setTimeout(_46.tickFunc,_6);};function _49(id,_4a,_4b){var _4c=_8[id],_4d=_4c.widget,_4e=_4c.node,_4f,x=_4c.scrollableX?Math.max(Math.min(0,_4a),-(_4c.scrollWidth-_4c.parentWidth)):_4a,y=_4c.scrollableY?Math.max(Math.min(0,_4b),-(_4c.scrollHeight-_4c.parentHeight)):_4b;function end(){delete _4c.transitionHandler;_4c.resetEffects();delete _8[id];};delete _4c.timer;if(x!==_4a||y!==_4b){_4c.transitionHandler=on.once(_4e,_f,end);_4e.style[_13+"Duration"]=_4d.bounceDuration+"ms";_4e.style[_14]=_15+x+"px,"+y+"px"+_16;if(x!==_4a&&_4c.scrollableX){_4f=_4c.widget._scrollbarXNode;_4f.style[_13+"Duration"]=_4d.bounceDuration+"ms";if(_4a>x){_4f.style[_14]=_15+"0,0"+_16;}else{_4f.style[_14]=_15+(_4f.parentNode.offsetWidth-_4f.offsetWidth)+"px,0"+_16;}}if(y!==_4b&&_4c.scrollableY){_4f=_4c.widget._scrollbarYNode;_4f.style[_13+"Duration"]=_4d.bounceDuration+"ms";if(_4b>y){_4f.style[_14]=_15+"0,0"+_16;}else{_4f.style[_14]=_15+"0,"+(_4f.parentNode.offsetHeight-_4f.offsetHeight)+"px"+_16;}}}else{end();}};function _45(id){var _50=_8[id],_51=_9[id],_52,_53,_54,_55=1.15;delete _9[id];if(_50.timer){clearTimeout(_50.timer);}_50.resetEffects=_2c;_52=_c.exec(_50.node.style[_14]);if(_52){_53=+_52[1];_54=+_52[2];}else{_53=_54=0;}if((!_50.velX&&!_50.velY)||((_53>=0||_53<=-(_50.scrollWidth-_50.parentWidth))&&(_54>=0||_54<=-(_50.scrollHeight-_50.parentHeight)))){_49(id,_53,_54);return;}function _56(a,b){return ((a.velX<=0&&b.velX<=0)||(a.velX>=0&&b.velX>=0))&&((a.velY<=0&&b.velY<=0)||(a.velY>=0&&b.velY>=0));};if(_51&&(_51.velX||_51.velY)&&_56(_50,_51)){_50.velX=(_50.velX+_51.velX)*_55;_50.velY=(_50.velY+_51.velY)*_55;}_50.lastX=_53;_50.lastY=_54;_50.calcFunc=function(){_57(id);};_50.timer=setTimeout(_50.calcFunc,_7);};function _57(id){var _58=_8[id],_59,_5a,_5b,i,nx,ny,nvx,nvy,_5c=6;if(!_58){return;}_59=_58.node;_5a=_59.parentNode;_5b=_58.widget;nvx=_5b.glideDecel(_58.velX);nvy=_5b.glideDecel(_58.velY);if(Math.abs(nvx)>=_a||Math.abs(nvy)>=_a){nx=_58.lastX+nvx;ny=_58.lastY+nvy;if(nx>0||nx<-(_58.scrollWidth-_58.parentWidth)){for(i=_5c;i--;){nvx=_5b.glideDecel(nvx);}}if(ny>0||ny<-(_58.scrollHeight-_58.parentHeight)){for(i=_5c;i--;){nvy=_5b.glideDecel(nvy);}}_23(_5b,-nx,-ny);_58.lastX=nx;_58.lastY=ny;_58.velX=nvx;_58.velY=nvy;_58.timer=setTimeout(_58.calcFunc,_7);}else{_49(id,_58.lastX,_58.lastY);}};return _1(null,{touchesToScroll:1,touchNode:null,scrollThreshold:10,bounceDuration:300,postCreate:function(){this._initTouch();this.inherited(arguments);},_initTouch:function(){var _5d=this.touchNode=this.touchNode||this.containerNode,_5e=this,_5f;if(!_5d||!_5d.parentNode){console.warn("TouchScroll requires a nested node upon which to operate.");return;}_5f=_5d.parentNode;_5f.style.overflow="hidden";_5d.style[_13+"Property"]=_12+"transform";_5d.style[_13+"TimingFunction"]="cubic-bezier(0.33, 0.66, 0.66, 1)";function _60(){_5e.cancelTouchScroll();};function _61(_62){return function(evt){evt.widget=_5e;evt.cancelTouchScroll=_60;_62.call(this,evt);};};this._touchScrollListeners=[on(_5f,"touchstart",_61(_30)),on(_5f,"touchmove",_61(_39)),on(_5f,"touchend,touchcancel",_61(_42))];},destroy:function(){var i=this._touchScrollListeners.length;while(i--){this._touchScrollListeners[i].remove();}delete _8[this.id];this.inherited(arguments);},scrollTo:function(_63){var _64=_8[this.id],_65=this.touchNode,_66=_65.parentNode;if(!_63.preserveMomentum&&_64&&_64.resetEffects){_64.resetEffects();}if(_63.x){_63.x=Math.max(0,Math.min(_63.x,_65.scrollWidth-_66.offsetWidth));}if(_63.y){_63.y=Math.max(0,Math.min(_63.y,_65.scrollHeight-_66.offsetHeight));}_23(this,_63);},getScrollPosition:function(){var _67=_2a(this);return _67?{x:-_67[1],y:-_67[2]}:{x:0,y:0};},cancelTouchScroll:function(){var _68=_8[this.id];if(!_68){return;}if(_68.resetEffects){_68.resetEffects();}else{if(_68.timer){clearTimeout(_68.timer);}_3.add(_68.node.parentNode,"touchscroll-fadeout");}delete _8[this.id];},glideDecel:function(n){return n*0.9;}});});