//>>built
define("dgrid/Keyboard",["dojo/_base/declare","dojo/aspect","dojo/dom-class","dojo/on","dojo/_base/lang","dojo/has","./util/misc","dojo/_base/sniff"],function(_1,_2,_3,on,_4,_5,_6){var _7={checkbox:1,radio:1,button:1},_8=/\bdgrid-cell\b/,_9=/\bdgrid-row\b/;var _a=_1(null,{pageSkip:10,tabIndex:0,keyMap:null,headerKeyMap:null,postMixInProperties:function(){this.inherited(arguments);if(!this.keyMap){this.keyMap=_4.mixin({},_a.defaultKeyMap);}if(!this.headerKeyMap){this.headerKeyMap=_4.mixin({},_a.defaultHeaderKeyMap);}},postCreate:function(){this.inherited(arguments);var _b=this;function _c(_d){var _e=_d.target;return _e.type&&(!_7[_e.type]||_d.keyCode===32);};function _f(_10){var _11=_b.cellNavigation,_12=_11?_8:_9,_13=_10===_b.headerNode,_14=_10;function _15(){if(_b._focusedHeaderNode){_b._focusedHeaderNode.tabIndex=-1;}if(_b.showHeader){if(_11){var _16=_b.headerNode.getElementsByTagName("th");for(var i=0,_17;(_17=_16[i]);++i){if(_12.test(_17.className)){_b._focusedHeaderNode=_14=_17;break;}}}else{_b._focusedHeaderNode=_14=_b.headerNode;}if(_14){_14.tabIndex=_b.tabIndex;}}};if(_13){_15();_2.after(_b,"renderHeader",_15,true);}else{_2.after(_b,"renderArray",function(_18){var _19=_b._focusedNode||_14;if(_12.test(_19.className)&&_6.contains(_10,_19)){return _18;}var _1a=_10.getElementsByTagName("*");for(var i=0,_1b;(_1b=_1a[i]);++i){if(_12.test(_1b.className)){_19=_b._focusedNode=_1b;break;}}_19.tabIndex=_b.tabIndex;return _18;});}_b._listeners.push(on(_10,"mousedown",function(_1c){if(!_c(_1c)){_b._focusOnNode(_1c.target,_13,_1c);}}));_b._listeners.push(on(_10,"keydown",function(_1d){if(_1d.metaKey||_1d.altKey){return;}var _1e=_b[_13?"headerKeyMap":"keyMap"][_1d.keyCode];if(_1e&&!_c(_1d)){_1e.call(_b,_1d);}}));};if(this.tabableHeader){_f(this.headerNode);on(this.headerNode,"dgrid-cellfocusin",function(){_b.scrollTo({x:this.scrollLeft});});}_f(this.contentNode);this._debouncedEnsureScroll=_6.debounce(this._ensureScroll,this);},removeRow:function(_1f){if(!this._focusedNode){return this.inherited(arguments);}var _20=this,_21=document.activeElement===this._focusedNode,_22=this[this.cellNavigation?"cell":"row"](this._focusedNode),_23=_22.row||_22,_24;_1f=_1f.element||_1f;if(_1f===_23.element){_24=this.down(_23,true);if(!_24||_24.element===_1f){_24=this.up(_23,true);}this._removedFocus={active:_21,rowId:_23.id,columnId:_22.column&&_22.column.id,siblingId:!_24||_24.element===_1f?undefined:_24.id};setTimeout(function(){if(_20._removedFocus){_20._restoreFocus(_23.id);}},0);this._focusedNode=null;}this.inherited(arguments);},insertRow:function(){var _25=this.inherited(arguments);if(this._removedFocus&&!this._removedFocus.wait){this._restoreFocus(_25);}return _25;},_restoreFocus:function(row){var _26=this._removedFocus,_27,_28;row=row&&this.row(row);_27=row&&row.element&&row.id===_26.rowId?row:typeof _26.siblingId!=="undefined"&&this.row(_26.siblingId);if(_27&&_27.element){if(!_27.element.parentNode.parentNode){_26.wait=true;return;}if(typeof _26.columnId!=="undefined"){_28=this.cell(_27,_26.columnId);if(_28&&_28.element){_27=_28;}}if(_26.active&&_27.element.offsetHeight!==0){this._focusOnNode(_27,false,null);}else{_3.add(_27.element,"dgrid-focus");_27.element.tabIndex=this.tabIndex;this._focusedNode=_27.element;}}delete this._removedFocus;},addKeyHandler:function(key,_29,_2a){return _2.after(this[_2a?"headerKeyMap":"keyMap"],key,_29,true);},_ensureRowScroll:function(_2b){var _2c=this.getScrollPosition().y;if(_2c>_2b.offsetTop){this.scrollTo({y:_2b.offsetTop});}else{if(_2c+this.contentNode.offsetHeight<_2b.offsetTop+_2b.offsetHeight){this.scrollTo({y:_2b.offsetTop-this.contentNode.offsetHeight+_2b.offsetHeight});}}},_ensureColumnScroll:function(_2d){var _2e=this.getScrollPosition().x;var _2f=_2d.offsetLeft;if(_2e>_2f){this.scrollTo({x:_2f});}else{var _30=this.bodyNode.clientWidth;var _31=_2d.offsetWidth;var _32=_2f+_31;if(_2e+_30<_32){this.scrollTo({x:_30>_31?_32-_30:_2f});}}},_ensureScroll:function(_33,_34){if(this.cellNavigation&&(this.columnSets||this.subRows.length>1)&&!_34){this._ensureRowScroll(_33.row.element);}if(this.bodyNode.clientWidth<this.contentNode.offsetWidth){this._ensureColumnScroll(_33.element);}},_focusOnNode:function(_35,_36,_37){var _38="_focused"+(_36?"Header":"")+"Node",_39=this[_38],_3a=this.cellNavigation?"cell":"row",_3b=this[_3a](_35),_3c,_3d,_3e,_3f,i;_35=_3b&&_3b.element;if(!_35){return;}if(this.cellNavigation){_3c=_35.getElementsByTagName("input");for(i=0,_3e=_3c.length;i<_3e;i++){_3d=_3c[i];if((_3d.tabIndex!==-1||"_dgridLastValue" in _3d)&&!_3d.disabled){_3d.focus();_3f=true;break;}}}if(_37!==null){_37=_4.mixin({grid:this},_37);if(_37.type){_37.parentType=_37.type;}if(!_37.bubbles){_37.bubbles=true;}}if(_39){_3.remove(_39,"dgrid-focus");_39.removeAttribute("tabindex");if(_37){_37[_3a]=this[_3a](_39);on.emit(_39,"dgrid-cellfocusout",_37);}}_39=this[_38]=_35;if(_37){_37[_3a]=_3b;}var _40=this.cellNavigation?_8:_9;if(!_3f&&_40.test(_35.className)){_35.tabIndex=this.tabIndex;_35.focus();}_3.add(_35,"dgrid-focus");if(_37){on.emit(_39,"dgrid-cellfocusin",_37);}this._debouncedEnsureScroll(_3b,_36);},focusHeader:function(_41){this._focusOnNode(_41||this._focusedHeaderNode,true);},focus:function(_42){var _43=_42||this._focusedNode;if(_43){this._focusOnNode(_43,false);}else{this.contentNode.focus();}}});var _44=_a.moveFocusVertical=function(_45,_46){var _47=this.cellNavigation,_48=this[_47?"cell":"row"](_45),_49=_47&&_48.column.id,_4a=this.down(this._focusedNode,_46,true);if(_47){_4a=this.cell(_4a,_49);}this._focusOnNode(_4a,false,_45);_45.preventDefault();};var _4b=_a.moveFocusUp=function(_4c){_44.call(this,_4c,-1);};var _4d=_a.moveFocusDown=function(_4e){_44.call(this,_4e,1);};var _4f=_a.moveFocusPageUp=function(_50){_44.call(this,_50,-this.pageSkip);};var _51=_a.moveFocusPageDown=function(_52){_44.call(this,_52,this.pageSkip);};var _53=_a.moveFocusHorizontal=function(_54,_55){if(!this.cellNavigation){return;}var _56=!this.row(_54),_57=this["_focused"+(_56?"Header":"")+"Node"];this._focusOnNode(this.right(_57,_55),_56,_54);_54.preventDefault();};var _58=_a.moveFocusLeft=function(_59){_53.call(this,_59,-1);};var _5a=_a.moveFocusRight=function(_5b){_53.call(this,_5b,1);};var _5c=_a.moveHeaderFocusEnd=function(_5d,_5e){var _5f;if(this.cellNavigation){_5f=this.headerNode.getElementsByTagName("th");this._focusOnNode(_5f[_5e?0:_5f.length-1],true,_5d);}_5d.preventDefault();};var _60=_a.moveHeaderFocusHome=function(_61){_5c.call(this,_61,true);};var _62=_a.moveFocusEnd=function(_63,_64){var _65=this.cellNavigation,_66=this.contentNode,_67=_64?0:_66.scrollHeight,_68=_66.scrollTop+_67,_69=_66[_64?"firstChild":"lastChild"],_6a=_69.className.indexOf("dgrid-preload")>-1,_6b=_6a?_69[(_64?"next":"previous")+"Sibling"]:_69,_6c=_6b.offsetTop+(_64?0:_6b.offsetHeight),_6d;if(_6a){while(_6b&&_6b.className.indexOf("dgrid-row")<0){_6b=_6b[(_64?"next":"previous")+"Sibling"];}if(!_6b){return;}}if(!_6a||_69.offsetHeight<1){if(_65){_6b=this.cell(_6b,this.cell(_63).column.id);}this._focusOnNode(_6b,false,_63);}else{if(!_5("dom-addeventlistener")){_63=_4.mixin({},_63);}_6d=_2.after(this,"renderArray",function(_6e){var _6f=_6e[_64?0:_6e.length-1];if(_65){_6f=this.cell(_6f,this.cell(_63).column.id);}this._focusOnNode(_6f,false,_63);_6d.remove();return _6e;});}if(_68===_6c){_63.preventDefault();}};var _70=_a.moveFocusHome=function(_71){_62.call(this,_71,true);};function _72(_73){_73.preventDefault();};_a.defaultKeyMap={32:_72,33:_4f,34:_51,35:_62,36:_70,37:_58,38:_4b,39:_5a,40:_4d};_a.defaultHeaderKeyMap={32:_72,35:_5c,36:_60,37:_58,39:_5a};return _a;});