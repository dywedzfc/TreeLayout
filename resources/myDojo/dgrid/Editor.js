//>>built
define("dgrid/Editor",["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/dom-construct","dojo/dom-class","dojo/on","dojo/has","dojo/query","./Grid","dojo/_base/sniff"],function(_1,_2,_3,_4,_5,on,_6,_7,_8){return _1(null,{constructor:function(){this._editorInstances={};this._editorColumnListeners=[];this._editorsPendingStartup=[];},postCreate:function(){var _9=this;this.inherited(arguments);this.on(".dgrid-input:focusin",function(){_9._focusedEditorCell=_9.cell(this);});this._editorFocusoutHandle=on.pausable(this.domNode,".dgrid-input:focusout",function(){_9._focusedEditorCell=null;});this._listeners.push(this._editorFocusoutHandle);},insertRow:function(){var _a=this.inherited(arguments);var _b=this.row(_a);var _c=this._previouslyFocusedEditorCell;if(_c&&_c.row.id===_b.id){this.edit(this.cell(_b,_c.column.id));}return _a;},removeRow:function(_d){var _e=this;var _f=this._focusedEditorCell;if(_f&&_f.row.id===this.row(_d).id){this._previouslyFocusedEditorCell=_f;this._editorFocusoutHandle.pause();setTimeout(function(){_e._editorFocusoutHandle.resume();_e._previouslyFocusedEditorCell=null;},0);}for(var i=this._alwaysOnWidgetColumns.length;i--;){var _10=this.cell(_d,this._alwaysOnWidgetColumns[i].id).element,_11=_10&&(_10.contents||_10).widget;if(_11){this._editorFocusoutHandle.pause();_11.destroyRecursive();}}return this.inherited(arguments);},renderArray:function(){var _12=this.inherited(arguments);if(_12.length){this._startupPendingEditors();}else{this._editorsPendingStartup=[];}return _12;},_onNotification:function(){this.inherited(arguments);this._startupPendingEditors();},_destroyColumns:function(){this._editorStructureCleanup();this.inherited(arguments);},_editorStructureCleanup:function(){var _13=this._editorInstances;var _14=this._editorColumnListeners;if(this._editTimer){clearTimeout(this._editTimer);}for(var _15 in _13){var _16=_13[_15];if(_16.domNode){_16.destroyRecursive();}}this._editorInstances={};for(var i=_14.length;i--;){_14[i].remove();}this._editorColumnListeners=[];this._editorsPendingStartup=[];},_configColumns:function(){var _17=this.inherited(arguments);this._alwaysOnWidgetColumns=[];for(var i=0,l=_17.length;i<l;i++){if(_17[i].editor){this._configureEditorColumn(_17[i]);}}return _17;},_configureEditorColumn:function(_18){var _19=_18.editor;var _1a=this;var _1b=_18.renderCell||this._defaultRenderCell;var _1c=_18.editOn;var _1d=typeof _19!=="string";if(_1c){this._editorInstances[_18.id]=this._createSharedEditor(_18,_1b);}else{if(_1d){this._alwaysOnWidgetColumns.push(_18);}}_18.renderCell=_1c?function(_1e,_1f,_20,_21){if(!_21||!_21.alreadyHooked){_1a._editorColumnListeners.push(on(_20,_1c,function(){_1a._activeOptions=_21;_1a.edit(this);}));}return _1b.call(_18,_1e,_1f,_20,_21);}:function(_22,_23,_24,_25){if(!_18.canEdit||_18.canEdit(_22,_23)){var cmp=_1a._createEditor(_18);_1a._showEditor(cmp,_18,_24,_23);_24[_1d?"widget":"input"]=cmp;}else{return _1b.call(_18,_22,_23,_24,_25);}};},edit:function(_26){var _27=this;var _28;var _29;var _2a;var _2b;var _2c;var cmp;var dfd;function _2d(dfd){_27._activeCell=_29;_27._showEditor(cmp,_28,_29,_2c);_27._editTimer=setTimeout(function(){if(cmp.focus){cmp.focus();}if(_28._editorBlurHandle){_28._editorBlurHandle.resume();}_27._editTimer=null;dfd.resolve(cmp);},0);};if(!_26.column){_26=this.cell(_26);}if(!_26||!_26.element){return null;}_28=_26.column;_2b=_28.field;_29=_26.element.contents||_26.element;if((cmp=this._editorInstances[_28.id])){if(this._activeCell!==_29){var row=_26.row;_2a=this.dirty&&this.dirty[row.id];_2c=(_2a&&_2b in _2a)?_2a[_2b]:_28.get?_28.get(row.data):row.data[_2b];if(!_28.canEdit||_28.canEdit(_26.row.data,_2c)){dfd=new _3();var _2e=cmp.domNode||cmp;if(_2e.offsetWidth){_2e.blur();setTimeout(function(){_2d(dfd);},0);}else{_2d(dfd);}return dfd.promise;}}}else{if(_28.editor){cmp=_29.widget||_29.input;if(cmp){dfd=new _3();if(cmp.focus){cmp.focus();}dfd.resolve(cmp);return dfd.promise;}}}return null;},_showEditor:function(cmp,_2f,_30,_31){var _32=cmp.domNode;if(!_32){this._updateInputValue(cmp,_31);}_30.innerHTML="";_5.add(_30,"dgrid-cell-editing");_30.appendChild(cmp.domNode||cmp);if(_32&&!_2f.editOn){this._editorsPendingStartup.push([cmp,_2f,_30,_31]);}else{this._startupEditor(cmp,_2f,_30,_31);}},_startupEditor:function(cmp,_33,_34,_35){if(cmp.domNode){if(!cmp._started){cmp.startup();}cmp._dgridIgnoreChange=true;cmp.set("value",_35);setTimeout(function(){cmp._dgridIgnoreChange=false;},0);}cmp._dgridLastValue=_35;if(this._activeCell){this._activeValue=_35;on.emit(_34,"dgrid-editor-show",{grid:this,cell:this.cell(_34),column:_33,editor:cmp,bubbles:true,cancelable:false});}},_startupPendingEditors:function(){var _36=this._editorsPendingStartup;for(var i=_36.length;i--;){this._startupEditor.apply(this,_36[i]);}this._editorsPendingStartup=[];},_handleEditorChange:function(evt,_37){var _38=evt.target;if("_dgridLastValue" in _38&&_38.className.indexOf("dgrid-input")>-1){this._updatePropertyFromEditor(_37||this.cell(_38).column,_38,evt);}},_createEditor:function(_39){var _3a=_39.editor,_3b=_39.editOn,_3c=this,_3d=typeof _3a!=="string"&&_3a,_3e,cmp,_3f,_40,_41={};_3e=_39.editorArgs||{};if(typeof _3e==="function"){_3e=_3e.call(this,_39);}if(_3d){cmp=new _3d(_3e);_3f=cmp.focusNode||cmp.domNode;_3f.className+=" dgrid-input";cmp.on(_3b?"blur":"change",function(){if(!cmp._dgridIgnoreChange){_3c._updatePropertyFromEditor(_39,this,{type:"widget"});}});}else{if(!this._hasInputListener){this._hasInputListener=true;this.on("change",function(evt){_3c._handleEditorChange(evt);});}if(_3a==="textarea"){_40==="textarea";}else{_40="input";_41.type=_3a;}cmp=_3f=_4.create(_40,_2.mixin(_41,{className:"dgrid-input",name:_39.field,tabIndex:isNaN(_39.tabIndex)?-1:_39.tabIndex},_3e));if(_6("ie")<9){if(_3a==="radio"||_3a==="checkbox"){this._editorColumnListeners.push(on(cmp,"click",function(evt){_3c._handleEditorChange(evt,_39);}));}else{this._editorColumnListeners.push(on(cmp,"change",function(evt){_3c._handleEditorChange(evt,_39);}));}}}if(_39.autoSelect){var _42=cmp.focusNode||cmp;if(_42.select){on(_42,"focus",function(){setTimeout(function(){_42.select();},0);});}}return cmp;},_createSharedEditor:function(_43){var cmp=this._createEditor(_43),_44=this,_45=cmp.domNode,_46=cmp.domNode||cmp,_47=cmp.focusNode||_46,_48=_45?function(){cmp.set("value",cmp._dgridLastValue);}:function(){_44._updateInputValue(cmp,cmp._dgridLastValue);_44._updatePropertyFromEditor(_43,cmp);};function _49(){var _4a=_44._activeCell;_47.blur();if(typeof _44.focus==="function"){setTimeout(function(){_44.focus(_4a);},_45&&_6("ie")<9?15:0);}};function _4b(){var _4c=_46.parentNode,_4d={alreadyHooked:true},_4e=_44.cell(_46);on.emit(_4e.element,"dgrid-editor-hide",{grid:_44,cell:_4e,column:_43,editor:cmp,bubbles:true,cancelable:false});_43._editorBlurHandle.pause();_4c.removeChild(_46);if(_4e.row){_5.remove(_4e.element,"dgrid-cell-editing");_4.empty(_4c);_8.appendIfNode(_4c,_43.renderCell(_4e.row.data,_44._activeValue,_4c,_44._activeOptions?_2.delegate(_4d,_44._activeOptions):_4d));}_44._focusedEditorCell=_44._activeCell=_44._activeValue=_44._activeOptions=null;};function _4f(evt){var key=evt.keyCode||evt.which;if(key===27){_48();_44._activeValue=cmp._dgridLastValue;_49();}else{if(key===13&&_43.dismissOnEnter!==false){_49();}}};this._editorColumnListeners.push(on(_47,"keydown",_4f));(_43._editorBlurHandle=on.pausable(cmp,"blur",_4b)).pause();this._editorColumnListeners.push(_43._editorBlurHandle);return cmp;},_updatePropertyFromEditor:function(_50,cmp,_51){var _52,id,_53;if(!cmp.isValid||cmp.isValid()){_52=this._updateProperty((cmp.domNode||cmp).parentNode,this._activeCell?this._activeValue:cmp._dgridLastValue,this._retrieveEditorValue(_50,cmp),_51);if(this._activeCell){this._activeValue=_52;}else{cmp._dgridLastValue=_52;}if(cmp.type==="radio"&&cmp.name&&!_50.editOn&&_50.field){_53=this.row(cmp);_7("input[type=radio][name="+cmp.name+"]",this.contentNode).forEach(function(_54){var row=this.row(_54);if(_54!==cmp&&_54._dgridLastValue){_54._dgridLastValue=false;if(this.updateDirty){this.updateDirty(row.id,_50.field,false);}else{row.data[_50.field]=false;}}},this);for(id in this.dirty){if(_53.id.toString()!==id&&this.dirty[id][_50.field]){this.updateDirty(id,_50.field,false);}}}}},_updateProperty:function(_55,_56,_57,_58){var _59=this;if((_56&&_56.valueOf())!==(_57&&_57.valueOf())){var _5a=this.cell(_55);var row=_5a.row;var _5b=_5a.column;_55=_5a.element;if(_5b.field&&row){var _5c={grid:this,cell:_5a,oldValue:_56,value:_57,bubbles:true,cancelable:true};if(_58&&_58.type){_5c.parentType=_58.type;}if(on.emit(_55,"dgrid-datachange",_5c)){if(this.updateDirty){this.updateDirty(row.id,_5b.field,_57);if(_5b.autoSave){setTimeout(function(){_59._trackError("save");},0);}}else{row.data[_5b.field]=_57;}}else{var cmp;if((cmp=_55.widget)){cmp._dgridIgnoreChange=true;cmp.set("value",_56);setTimeout(function(){cmp._dgridIgnoreChange=false;},0);}else{if((cmp=_55.input)){this._updateInputValue(cmp,_56);}}return _56;}}}return _57;},_updateInputValue:function(_5d,_5e){_5d.value=_5e;if(_5d.type==="radio"||_5d.type==="checkbox"){_5d.checked=_5d.defaultChecked=!!_5e;}},_retrieveEditorValue:function(_5f,cmp){if(typeof cmp.get==="function"){return this._convertEditorValue(cmp.get("value"));}else{return this._convertEditorValue(cmp[cmp.type==="checkbox"||cmp.type==="radio"?"checked":"value"]);}},_convertEditorValue:function(_60,_61){if(typeof _61==="number"){_60=isNaN(_60)?_60:parseFloat(_60);}else{if(typeof _61==="boolean"){_60=_60==="true"?true:_60==="false"?false:_60;}else{if(_61 instanceof Date){var _62=new Date(_60);_60=isNaN(_62.getTime())?_60:_62;}}}return _60;}});});