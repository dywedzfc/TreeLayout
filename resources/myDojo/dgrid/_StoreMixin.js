//>>built
define("dgrid/_StoreMixin",["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/aspect","dojo/dom-construct","dojo/has","dojo/on","dojo/when"],function(_1,_2,_3,_4,_5,_6,on,_7){function _8(_9){if(typeof _9!=="object"){_9=new Error(_9);}else{if(_9.dojoType==="cancel"){return;}}var _a=on.emit(this.domNode,"dgrid-error",{grid:this,error:_9,cancelable:true,bubbles:true});if(_a){console.error(_9);}};return _1(null,{collection:null,_renderedCollection:null,_rows:null,_observerHandle:null,shouldTrackCollection:true,getBeforePut:true,noDataMessage:"",loadingMessage:"",_total:0,constructor:function(){this.dirty={};this._updating={};this._columnsWithSet={};_4.before(this,"configStructure",_2.hitch(this,function(){this._columnsWithSet={};}));},destroy:function(){this.inherited(arguments);if(this._renderedCollection){this._cleanupCollection();}},_configColumn:function(_b){if(_b.set){this._columnsWithSet[_b.field]=_b;}this.inherited(arguments);},_setCollection:function(_c){if(this._renderedCollection){this.cleanup();this._cleanupCollection({shouldRevert:!_c||_c.storage!==this._renderedCollection.storage});}if(_c){var _d=_c;if(this.sort&&this.sort.length>0){_d=_c.sort(this.sort);}if(_d.track&&this.shouldTrackCollection){_d=_d.track();this._rows=[];this._observerHandle=this._observeCollection(_d,this.contentNode,{rows:this._rows});}this._renderedCollection=_d;}this.collection=_c;if(this._started){this.refresh();}},_setStore:function(){if(!this.collection){}},_getTotal:function(){return this._total;},_cleanupCollection:function(_e){_e=_e||{};if(this._renderedCollection.tracking){this._renderedCollection.tracking.remove();}if(this._observerHandle){this._observerHandle.remove();this._observerHandle=this._rows=null;}if(_e.shouldRevert!==false){this.dirty={};}this._renderedCollection=this.collection=null;},_applySort:function(){if(this.collection){this.set("collection",this.collection);}else{if(this.store){}}},row:function(){var _f=this.inherited(arguments);if(_f&&_f.data&&typeof _f.id!=="undefined"){_f.id=this.collection.getIdentity(_f.data);}return _f;},refresh:function(){var _10=this.inherited(arguments);if(!this.collection){this.noDataNode=_5.create("div",{className:"dgrid-no-data",innerHTML:this.noDataMessage},this.contentNode);}return _10;},renderArray:function(){var _11=this.inherited(arguments);if(!this.collection){if(_11.length&&this.noDataNode){_5.destroy(this.noDataNode);}}return _11;},insertRow:function(_12,_13,_14,i,_15){var _16=this.collection,_17=this.dirty,id=_16&&_16.getIdentity(_12),_18,row;if(id in _17&&!(id in this._updating)){_18=_17[id];}if(_18){_12=_2.delegate(_12,_18);}row=this.inherited(arguments);if(_15&&_15.rows){_15.rows[i]=row;}if(this.noDataNode){_5.destroy(this.noDataNode);this.noDataNode=null;}return row;},updateDirty:function(id,_19,_1a){var _1b=this.dirty,_1c=_1b[id];if(!_1c){_1c=_1b[id]={};}_1c[_19]=_1a;},save:function(){var _1d=this,_1e=this.collection,_1f=this.dirty,dfd=new _3(),_20=dfd.promise,_21=function(id){var _22;return (_1d.getBeforePut||!(_22=_1d.row(id).data))?function(){return _1e.get(id);}:function(){return _22;};};function _23(id,_24){return function(_25){var _26=_1d._columnsWithSet,_27=_1d._updating,key,_28;if(typeof _25.set==="function"){_25.set(_24);}else{for(key in _24){_25[key]=_24[key];}}for(key in _26){_28=_26[key].set(_25);if(_28!==undefined){_25[key]=_28;}}_27[id]=true;return _1e.put(_25).then(function(){delete _1f[id];delete _27[id];});};};for(var id in _1f){var put=_23(id,_1f[id]);_20=_20.then(_21(id)).then(put);}dfd.resolve();return _20;},revert:function(){this.dirty={};this.refresh();},_trackError:function(_29){if(typeof _29==="string"){_29=_2.hitch(this,_29);}var _2a=this,_2b;try{_2b=_7(_29());}catch(err){var dfd=new _3();dfd.reject(err);_2b=dfd.promise;}_2b.otherwise(function(err){_8.call(_2a,err);});return _2b;},removeRow:function(_2c,_2d,_2e){var row={element:_2c};if(!_2d&&this.noDataMessage&&(this.up(row).element===_2c)&&(this.down(row).element===_2c)){this.noDataNode=_5.create("div",{className:"dgrid-no-data",innerHTML:this.noDataMessage},this.contentNode);}var _2f=(_2e&&_2e.rows)||this._rows;if(_2f){delete _2f[_2c.rowIndex];}return this.inherited(arguments);},renderQueryResults:function(_30,_31,_32){_32=_2.mixin({rows:this._rows},_32);var _33=this;if(!1){_30.totalLength.then(function(_34){if(_34==null){console.warn("Store reported null or undefined totalLength. "+"Make sure your store (and service, if applicable) are reporting total correctly!");}});}return _30.then(function(_35){var _36=_33.renderArray(_35,_31,_32);delete _33._lastCollection;return _36;});},_observeCollection:function(_37,_38,_39){var _3a=this,_3b=_39.rows,row;var _3c=[_37.on("delete, update",function(_3d){var _3e=_3d.previousIndex;var to=_3d.index;if(_3e!==undefined&&_3b[_3e]){if("max" in _3b&&(to===undefined||to<_3b.min||to>_3b.max)){_3b.max--;}row=_3b[_3e];if(row.parentNode===_38){_3a.removeRow(row,false,_39);}_3b.splice(_3e,1);if(_3d.type==="delete"||(_3d.type==="update"&&(_3e<to||to===undefined))){_3b[_3e]&&_3b[_3e].rowIndex--;}if(_3a._processScroll){_3a._processScroll();}}if(_3d.type==="delete"){row=null;}}),_37.on("add, update",function(_3f){var _40=_3f.previousIndex;var to=_3f.index;var _41;function _42(){_41=(_41.connected||_41).nextSibling;};if(to!==undefined&&(!("max" in _3b)||(to>=_3b.min&&to<=_3b.max))){if("max" in _3b&&(_40===undefined||_40<_3b.min||_40>_3b.max)){_3b.max++;}if(_3b.length){_41=_3b[to];if(!_41){_41=_3b[to-1];if(_41){_42();}}}else{_41=_3a._getFirstRowSibling&&_3a._getFirstRowSibling(_38);}if(row&&_41&&row.id===_41.id){_42();}if(_41&&!_41.parentNode){_41=document.getElementById(_41.id);}_3b.splice(to,0,undefined);row=_3a.insertRow(_3f.target,_38,_41,to,_39);_3a.highlightRow(row);}row=null;}),_37.on("add, delete, update",function(_43){var _44=(typeof _43.previousIndex!=="undefined")?_43.previousIndex:Infinity,to=(typeof _43.index!=="undefined")?_43.index:Infinity,_45=Math.min(_44,to);_44!==to&&_3b[_45]&&_3a.adjustRowIndices(_3b[_45]);_3a._onNotification(_3b,_43,_37);if(_37===_3a._renderedCollection&&"totalLength" in _43){_3a._total=_43.totalLength;}})];return {remove:function(){while(_3c.length>0){_3c.pop().remove();}}};},_onNotification:function(){}});});